---
title: "Droplet filtering metrics (sample)"
output: html_document
author: "Kevin Rue"
date: "`r Sys.Date()`"
---

```{r libraries, include=FALSE}
library(DropletUtils)
library(tidyverse)
```

```{r setup, include=FALSE}
# use this code chunk to set up constants
```

```{r snakemake, include=FALSE}
# "results/vireo/{id}" (character vector)
vireo_dir <- snakemake@input[["vireo"]]
dropletqc_csv <- snakemake@input[["dropletqc"]]
cellranger_bam <- snakemake@input[["cellranger"]]
```

```{r vireo_file, include=FALSE}
# "results/vireo/{id}/summary.tsv" (character(1))
vireo_file <- file.path(vireo_dir, "donor_ids.tsv")
```

```{r cellranger_h5, include=FALSE}
# "results/cellranger_count/{id}/outs/possorted_genome_bam.bam" (character(1))
cellranger_h5 <- file.path(dirname(cellranger_bam), "filtered_feature_bc_matrix.h5")
```

## Information

```{r information, include=FALSE}
sample_name <- basename(vireo_dir)
```

- **Sample:** `r sample_name`
- **CellRanger file:** `r cellranger_h5`
- **Vireo file:** `r vireo_file`
- **DropletQC file:** `r dropletqc_csv`

```{r sce, include=FALSE}
sce <- read10xCounts(cellranger_h5, col.names = TRUE)
```

```{r cell_names, include=FALSE}
cell_names <- colnames(sce)
```

```{r vireo_data, include=FALSE}
# "results/vireo/{id}/summary.tsv" (character vector)
vireo_data <- read_tsv(vireo_file)
```

```{r dropletqc_data, include=FALSE}
dropletqc_data <- read_csv(dropletqc_csv, col_names = c("cell", "nuclear_fraction"), skip = 1)
```

```{r cell_stats, include=FALSE}
cell_stats <- tibble(
  cell = cell_names,
  sum = colSums(counts(sce))
) %>%
  left_join(
    dropletqc_data,
    by = "cell"
  ) %>%
  left_join(
    vireo_data,
    by = "cell"
  )
```

## Plots

```{r plot_assigned, echo=FALSE}
ggplot() +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(donor_id %in% c("doublet", "unassigned")),
    colour = "#b3b3b3",
    size = 0.1
  ) +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(!donor_id %in% c("doublet", "unassigned")),
    colour = "#F8766D",
    size = 0.1
  ) +
  geom_point(size = 0.1) +
  labs(
    x = "Nuclear fraction",
    y = "UMI sum (log10)",
    title = sprintf("Assigned to donor (%s)", sample_name)
  ) +
  guides(colour = "none") +
  theme_bw()
```

```{r plot_doublet, echo=FALSE}
ggplot() +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(donor_id != "doublet"),
    colour = "#b3b3b3",
    size = 0.1
  ) +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(donor_id == "doublet"),
    colour = "#F8766D",
    size = 0.1
  ) +
  labs(
    x = "Nuclear fraction",
    y = "UMI sum (log10)",
    title = sprintf("Doublet (%s)", sample_name)
  ) +
  guides(colour = "none") +
  theme_bw()
```

```{r plot_unassigned, echo=FALSE}
ggplot() +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(donor_id != "unassigned"),
    colour = "#b3b3b3",
    size = 0.1
  ) +
  geom_point(
    mapping = aes(x = nuclear_fraction, y = log10(sum)),
    data = cell_stats %>% filter(donor_id == "unassigned"),
    colour = "#F8766D",
    size = 0.1
  ) +
  labs(
    x = "Nuclear fraction",
    y = "UMI sum (log10)",
    title = sprintf("Unassigned (%s)", sample_name)
  ) +
  guides(colour = "none") +
  theme_bw()
```
